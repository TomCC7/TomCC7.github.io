---
title: NAS Configuration
categories: configurations
layout: post
---



[TOC]

## LAMP环境搭建

### 简介

​	LAMP是一套建站环境的缩写，nextcloud必须依赖这套环境才能运行。其中linux系统我们已经有了，还需要安装其它三个。

![lamp](https://www.player7.cc:44343/uploads/big/dd322ee03d6c8a2f496ba21481f66672.png)

### 1. PHP

​	这里选用php7.3版本

```bash
sudo apt install php7.3 #安装php

sudo apt install php7.3-mysql php7.3-zip php7.3-xml php7.3-intl php7.3-mbstring php7.3-gd php7.3-curl #安装依赖模块
```



### 2. Apache2

```bash
sudo apt install apache2 libapache2-mod-php #安装apache2和php解析模块

sudo systemctl restart apache2 #启动
```



### 3. MySQL（Mariadb）

#### 3.1 下载

​	这里使用的**Mariadb**是**MySQL**的一套开源版本，可以完全兼容mysql的命令。

```bash
sudo apt install mariadb-server
```

#### 3.2 配置数据库

​	输入命令：`sudo mysql -u root` 进入管理界面。

```sql
CREATE DATABASE IF NOT EXISTS nextcloud;#创建数据库
GRANT ALL ON nextcloud.* TO '用户名'@'localhost' IDENTIFIED BY '密码'; #创建用户并授予权限
quit;#退出到bash
```

```bash
sudo systemctl restart mariadb #重启服务使之生效
```



## Nextcloud

1. 从[官网](https://nextcloud.com/install/)下载最新版软件：

```bash
wget https://download.nextcloud.com/server/releases/nextcloud-18.0.1.zip #下载
sudo unzip nextcloud-18.0.0.zip -d /var/www/html #解压缩到apache服务器根目录下
sudo chown -R www-data:www-data /var/www/html/nextcloud/ #设置权限
```

​	现在在浏览器访问`http://树莓派ip/nextcloud`应有如下界面：

![nextcloudlogin](https://www.player7.cc:44343/uploads/big/5039d2c6b58d95617f39da5e004e457b.png)

2. 接下来我们要设置存放数据的data目录。由于要将数据存放在移动硬盘中，我们需要先挂载硬盘。

   为了挂载硬盘，首先我们要获取硬盘的**uuid**(Universally Unique IDentifiers)：

```bash
ls -l /dev/disk/by-uuid
```

![uuid](https://www.player7.cc:44343/uploads/big/a845f237450825dc5c78fb116161449a.png)

​	上图最后一行../../sda1即为我们的移动硬盘，而`8EA8F491A8F47953`即为硬盘特有的UUID。

​	修改fstab文件自动挂载硬盘：`sudo nano /etc/fstab`

```
#将以下内容更改后复制进文件末尾
UUID=之前获得的UUID /mnt/drive auto nofail,uid=33,gid=33,umask=0027,dmask=0027,noatime 0 0
```

​	保存退出后后输入`sudo reboot`重启系统，挂载完成。

<hr>



​	创建data目录:

```bash
sudo mkdir /mnt/drive/data/ #创建目录
sudo chown -R www-data:www-data /mnt/drive/data #修改权限
```

​	接下来我们重新打开云盘页面：

![nextcloudlogin](https://www.player7.cc:44343/uploads/big/8d0bf7ef46213fcd8e16ca46ed48e42d.png)

依次填入所需信息后确认：

+ 管理员账号是云盘的登录名和密码，可以自己设置

+ 数据目录为刚刚创建的data文件夹:/mnt/drive/data
+ 数据库名为`nextcloud`，用户名密码为[配置数据库](#3.2 配置数据库)时创建的用户名和密码。

![登录界面](/home/cc/Documents/notes/photos/nextcloudlogin2.png)

​	这样我们的nextcloud云盘就可以在内网下使用了。

### OCC命令

```bash
cd nextcloud #切换到nextcloud根目录
sudo -u www-data php occ files:scan ccadmin --verbose #扫描文件并显示输出
```

## 将多块系统盘合并

> https://wzyboy.im/post/1148.html

1. 下载[mergerfs](https://github.com/trapexit/mergerfs)
2. 挂载

```bash
/mnt/disk1T:/mnt/disk2  /mnt/vdisk    fuse.mergerfs defaults,noauto,allow_other,use_ino,minfreespace=100G,ignorepponrename=true 0 0
```

- `defaults`: 开启以下 FUSE 参数以提升性能：atomic_o_trunc, auto_cache, big_writes, default_permissions, splice_move, splice_read, splice_write；
- `noauto`: 禁止开机自动挂载。意外关机重启之后我可能需要手动检查文件系统后再挂载，所以我不希望它自动挂载；
- `allow_other`: 允许挂载者以外的用户访问 FUSE。你可能需要编辑 `/etc/fuse.conf` 来允许这一选项；
- `use_ino`: 使用 mergerfs 而不是 libfuse 提供的 inode，使硬链接的文件 inode 一致；
- `minfreespace=100G`: 选择往哪个下层文件系统写文件时，跳过剩余空间低于 100G 的文件系统；
- `ignorepponrename=true`: 重命名文件时，不再遵守路径保留原则，见下一节详解。