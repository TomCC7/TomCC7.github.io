---
title: OpenCV notes
categories: notes
layout: post
---

[toc]

# 学习参考

- 仿射变换
  - https://www.matongxue.com/madocs/244/ 
- 傅里叶变换
  - https://zhuanlan.zhihu.com/p/99605178
- 大津二值化
  - https://en.wikipedia.org/wiki/Otsu%27s_method
  - https://learnopencv.com/otsu-thresholding-with-opencv/



# 编译安装

## Archlinux

### 编译指令

```bash
# dependencies
aurman -S build-devel cmake libjpeg libtiff libpng xvidcore libx264 ffmpeg v4l-utils gtk3 libcanberra lapack gcc-fortran
# python
sudo pip3 install virtualenv virtualenvwrapper
mkvirtualenv cv -p python3
workon cv
# deactivate
cd <build>
# cmake
cmake -D CMAKE_INSTALL_PREFIX=/usr/local \
-D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-4.1.0/modules/ \
-D BUILD_TESTS=OFF \
-D INSTALL_PYTHON_EXAMPLES=OFF \
-D OPENCV_ENABLE_NONFREE=ON \
-D BUILD_opencv_python3=TRUE \
-D BUILD_EXAMPLES=OFF \
-D WITH_OPENMP=ON \
..
# make
make -j6
sudo make install
sudo ldconfig
```



## 树梅派安装opencv

> 参考：https://www.pyimagesearch.com/2017/09/04/raspbian-stretch-install-opencv-3-python-on-your-raspberry-pi/

> 非编译安装: https://zhuanlan.zhihu.com/p/92184435

### 树梅派设置

1. 将系统扩展至整个sd卡
2. 把swap调大

```bash
sudo vim /etc/dphys-swapfile
# 修改这行
CONF_SWAPSIZE = 1024
#重启生效配置
sudo /etc/init.d/dphys-swapfile restart
```



### 安装依赖

```bash
# build
sudo apt install build-essential cmake pkg-config -y
# figure processing
sudo apt install libjpeg-dev libtiff5-dev libjasper-dev libpng12-dev -y
# image I/O
sudo apt install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev -y
sudo apt install libxvidcore-dev libx264-dev -y
sudo apt install libgtk2.0-dev libgtk-3-dev -y
sudo apt install libatlas-base-dev gfortran -y
# install python
sudo apt install python3-dev -y
```

```bash
# ubuntu
sudo apt install build-essential 
sudo apt install cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev
sudo apt install python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libdc1394-22-dev
```



### 下载opencv源码

- [opencv](https://github.com/opencv/opencv/releases) - opencv官方仓库

- [opencv_contrib](https://github.com/opencv/opencv_contrib) - opencv额外模组库

  从以上仓库分别下载相同版本的代码，之后解压在同一文件夹下。

### 安装python虚拟环境

```bash
# 安装virtualenv
sudo python3 -m pip install virtualenv virtualenvwrapper
sudo rm -rf ~/.cache/pip

# 添加path
# 将以下复制到~/.profile中
# virtualenv and virtualenvwrapper
export WORKON_HOME=$HOME/.virtualenvs
export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3
source /usr/local/bin/virtualenvwrapper.sh

#创建虚拟环境
source ~/.profile #引入环境变量
mkvirtualenv cv -p python3 #创建环境
workon cv #选择环境
```

### 安装numpy

```bash
python3 -m pip install numpy
```

### 编译

```bash
#确保处于opencv主文件夹内
mkdir build && cd build #创建build文件夹并进入
#运行cmake生成makefile文件 大概1分钟多
cmake -D CMAKE_BUILD_TYPE=RELEASE \
        -D OPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-4.4.0/modules \
        -D WITH_LIBV4L=ON \
        -D WITH_CUDA=ON \
        -D ENABLE_FAST_MATH=ON \
        -D CUDA_FAST_MATH=ON \
        -D WITH_CUBLAS=ON \
        -D WITH_NVCUVID=ON \
        -D CUDA_GENERATION=Auto \
        -D WITH_TBB=ON \
        -D WITH_OPENMP=ON \
        -D WITH_OPENGL=ON \
        -D PYTHON3_EXECUTABLE=/usr/bin/python3 \
        -D PYTHON3_LIBRARY=/usr/lib/python3.8/config-3.8-x86_64-linux-gnu/libpython3.8.so \
		-D INSTALL_C_EXAMPLES_=ON \
		-D CMAKE_INSTALL_PREFIX=/usr/local ..
# make,大概几个小时
make -j4 #这里会报错， 之后讲
# 安装
sudo make install
sudo ldconfig
```

### 最后的收尾工作

```bash
cd /usr/local/lib/python3.x/site-packages/cv2/
# 寻找一个大概叫cv2.cpython-35m-arm-linux-gnueabihf.so的文件
# 改名为cv2.so
sudo mv cv2.cpython-35m-arm-linux-gnueabihf.so cv2.so

# 创建软链接至虚拟环境
cd ~/.virtualenvs/cd/lib/python3.x/site-packages/
ln -s (cv2.so绝对位置) cv2.so
```

### 解决蛋疼的报错

>/home/tellw/opencv-4.1.2/opencv_contrib-4.1.2/modules/xfeatures2d/src/boostdesc.cpp:654:20: fatal error: boostdesc_bgm.i: No such file or directory
>\#include "boostdesc_bgm.i"
>    ^~~~~~~~~~~~~~~~~

```bash
# 反正就是少东西，要下载
# https://github.com/opencv/opencv_3rdparty 网址，里面不同分支有不同东西
cd ~/opencv-4.1.2/opencv_contrib-4.1.2/modules/xfeatures2d/src
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_lbgm.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_binboost_256.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_binboost_128.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_binboost_064.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_bgm_hd.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_bgm_bi.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/34e4206aef44d50e6bbcd0ab06354b52e7466d26/boostdesc_bgm.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/fccf7cd6a4b12079f73bbfb21745f9babcd4eb1d/vgg_generated_120.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/fccf7cd6a4b12079f73bbfb21745f9babcd4eb1d/vgg_generated_64.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/fccf7cd6a4b12079f73bbfb21745f9babcd4eb1d/vgg_generated_48.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/fccf7cd6a4b12079f73bbfb21745f9babcd4eb1d/vgg_generated_80.i
wget https://raw.githubusercontent.com/opencv/opencv_3rdparty/contrib_xfeatures2d_boostdesc_20161012/boostdesc_bgm_bi.i
```

> /home/tellw/opencv-4.1.2/opencv_contrib-4.1.2/modules/xfeatures2d/test/test_features2d.cpp:51:10: fatal error: features2d/test/test_detectors_regression.impl.hpp: No such file or directory
>  \#include "features2d/test/test_detectors_regression.impl.hpp"
>      ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

奇怪的报错， 解决方法也很奇怪。。

```bash
sudo cp -r ()/opencv-4.1.2/modules/features2d ()/opencv-4.1.2/build
```

这俩问题解决完理论上就没问题了

我的版本为4.4.0y